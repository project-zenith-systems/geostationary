name: Validate PR Target Branch

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  validate-target:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: read
    steps:
      - name: Check task PR targets correct plan branch
        uses: actions/github-script@v7
        with:
          script: |
            const head = context.payload.pull_request.head.ref;
            const base = context.payload.pull_request.base.ref;

            // Only enforce on task/* branches
            const match = head.match(/^task\/(\d+)-/);
            if (!match) {
              core.info(`Branch "${head}" is not a task branch — skipping.`);
              return;
            }

            const issueNumber = parseInt(match[1], 10);
            core.info(`Task branch detected — linked to issue #${issueNumber}`);

            // Fetch the issue body
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            if (!issue.body) {
              core.info(`Issue #${issueNumber} has no body — skipping.`);
              return;
            }

            // Parse for **Plan:** `plan/<name>`
            const planMatch = issue.body.match(/\*\*Plan:\*\*\s*`(plan\/[^`]+)`/);
            if (!planMatch) {
              core.info(`Issue #${issueNumber} has no plan branch reference — skipping.`);
              return;
            }

            const expectedBase = planMatch[1];
            core.info(`Issue #${issueNumber} belongs to ${expectedBase}`);

            if (base !== expectedBase) {
              core.setFailed(
                `This PR targets \`${base}\` but issue #${issueNumber} belongs to \`${expectedBase}\`.\n` +
                `Change the base branch to \`${expectedBase}\`.`
              );
            } else {
              core.info(`PR correctly targets ${expectedBase}.`);
            }
